{% extends "base.html" %}
{% block title %}Net Business{% endblock %}
{% block content %}
<style>
.card-compact { background:#fff; padding:1rem; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
.table-sm td, .table-sm th { padding:0.4rem 0.6rem; }
.net-row { background: linear-gradient(90deg,#e6fffa,#f0fff4); font-weight:700; }
.redemption { color: #e53e3e; font-weight:600; }
.redemption, .redemption * { color: #e53e3e !important; font-weight:600; }
.net-cell { background: linear-gradient(90deg,#fff9db,#fff7ed); font-weight:700; }
</style>
<div class="card-compact">
  <h2>Net Business</h2>
  <p class="text-muted">View net business (Sales − Redemptions/SIP stoppage)</p>

  <form method="get" class="row g-2 align-items-end">
      <div class="col-auto">
      <label class="form-label small">From</label>
      <input type="date" name="start" class="form-control form-control-sm" value="{{ start_str }}">
    </div>
    <div class="col-auto">
      <label class="form-label small">To</label>
      <input type="date" name="end" class="form-control form-control-sm" value="{{ end_str }}">
    </div>
    <div class="col-auto">
      <label class="form-label small">Granularity</label>
      <select name="granularity" class="form-select form-select-sm">
  <option value="day" {% if granularity == 'day' %}selected{% endif %}>Day</option>
  <option value="month" {% if granularity == 'month' %}selected{% endif %}>Month</option>
  <option value="year" {% if granularity == 'year' %}selected{% endif %}>Year</option>
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label small">Product</label>
      <select name="product" class="form-select form-select-sm">
        <option value="" {% if not selected_product %}selected{% endif %}>All</option>
        {% for p in products %}
          <option value="{{ p }}" {% if selected_product == p %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-primary btn-sm">Apply</button>
    </div>
  </form>

  <hr />

  <h5>Totals by product</h5>
  <table class="table table-sm">
    <thead>
      <tr>
        <th>Product</th>
        <th>Transactions</th>
        <th>Sales</th>
        <th>Redemptions</th>
        <th>Net</th>
      </tr>
    </thead>
    <tbody>
      {% for prod, vals in totals.items %}
        <tr>
          <td>
            <a href="{% url 'clients:all_sales' %}?product={{ prod|urlencode }}&start_date={{ start_str }}&end_date={{ end_str }}">{{ prod }}</a>
          </td>
          <td>{{ vals.count|default:0 }}</td>
          <td>₹{{ vals.sales|floatformat:2 }}</td>
          <td class="redemption text-danger">₹{{ vals.redemptions|floatformat:2 }}</td>
          <td class="net-cell">₹{{ vals.net|floatformat:2 }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="5" class="text-muted">No data</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <hr />
  <h5>Detailed</h5>
  <table class="table table-sm">
    <thead>
      <tr>
        <th>Metric</th>
        {% for prod in totals.keys %}
          <th>{{ prod }}</th>
        {% empty %}
          <th class="text-muted">No products</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>Sales</strong></td>
        {% for prod, vals in totals.items %}
          <td>₹{{ vals.sales|floatformat:2 }}</td>
        {% endfor %}
      </tr>
      <tr>
        <td><strong>Redemptions</strong></td>
        {% for prod, vals in totals.items %}
           <td class="redemption text-danger">₹{{ vals.redemptions|floatformat:2 }}</td>
        {% endfor %}
      </tr>
      <tr class="net-row">
        <td><strong>Net</strong></td>
        {% for prod, vals in totals.items %}
          <td class="net-cell">₹{{ vals.net|floatformat:2 }}</td>
        {% endfor %}
      </tr>
    </tbody>
  </table>

  <hr />
  <h5>Add Redemption / SIP Stoppage</h5>
  <form method="post" class="row g-2">
    {% csrf_token %}
    <div class="col-auto">
      <label class="form-label small">Product</label>
      <select name="product" class="form-select form-select-sm" required>
        {% for p in products %}
          <option value="{{ p }}">{{ p }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label small">Type</label>
      <select name="entry_type" class="form-select form-select-sm">
        <option value="redemption">Redemption (Lumsum)</option>
        <option value="sip_stoppage">SIP Stoppage</option>
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label small">Amount</label>
      <input type="number" step="0.01" name="amount" class="form-control form-control-sm" required>
    </div>
    <div class="col-auto">
      <label class="form-label small">Date</label>
      <input type="date" name="date" class="form-control form-control-sm" value="{{ end_str }}">
    </div>
    <div class="col-12">
      <label class="form-label small">Note (optional)</label>
      <input type="text" name="note" class="form-control form-control-sm">
    </div>
    <div class="col-auto">
      <button class="btn btn-warning btn-sm">Add Entry</button>
    </div>
  </form>

</div>
{% endblock %}
