{% extends "base.html" %}
{% load static %}
{% block title %}Admin Past Performance{% endblock %}
{% block content %}
<style>
  .section-title { font-size: 1.2rem; font-weight: 700; color: #2d3748; margin: 1.5rem 0 1rem; }
  .modern-card { background:#fff; border-radius:16px; box-shadow:0 2px 14px rgba(0,0,0,0.08); padding:1.2rem; margin-bottom:1rem; }
  .pill { display:inline-flex; align-items:center; gap:0.4rem; padding:0.35rem 0.75rem; border-radius:999px; background:#edf2f7; color:#2d3748; font-weight:600; font-size:0.95rem; }
  .grid { display:grid; gap:1rem; }
  @media (min-width: 900px) { .grid-3 { grid-template-columns: repeat(3, minmax(0,1fr)); } }
  @media (max-width: 899px) { .grid-3 { grid-template-columns: repeat(1, minmax(0,1fr)); } }
  .mini { font-size:0.9rem; color:#4a5568; }
  .bar { height:12px; background:#edf2f7; border-radius:8px; overflow:hidden; }
  .bar-fill { height:100%; border-radius:8px; background:linear-gradient(90deg,#f6ad55 0%, #ed8936 100%); }
</style>

<div class="section-title">Performance Overview (Last {{ months_data|length }} Months)</div>

<div class="modern-card">
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;">
    <div class="pill">Latest: {{ latest_month_label }}</div>
    <div class="pill">Scope: {{ scope_label }}</div>
    <a href="{% url 'clients:admin_dashboard' %}" class="dashboard-link" style="padding:0.45rem 0.9rem;font-size:0.95rem;">Back to Dashboard</a>
  </div>
  <canvas id="adminPerformanceChart" height="100" class="mt-3"></canvas>
</div>

<div class="section-title" style="display:flex;justify-content:space-between;align-items:center;gap:0.75rem;flex-wrap:wrap;">
  <span>Monthly Snapshots — {{ selected_year }}</span>
  <form method="get" style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">
    <label for="year" class="mini" style="font-weight:600;">Year</label>
    <select name="year" id="year" onchange="this.form.submit()" style="padding:0.35rem 0.6rem;border-radius:8px;border:1px solid #cbd5e0;">
      {% for y in year_options %}
        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
    <label for="employee" class="mini" style="font-weight:600;">Employee</label>
    <select name="employee" id="employee" onchange="this.form.submit()" style="padding:0.35rem 0.6rem;border-radius:8px;border:1px solid #cbd5e0;">
      <option value="all" {% if not selected_employee_id %}selected{% endif %}>All Employees (cumulative)</option>
      {% for e in employees %}
        <option value="{{ e.id }}" {% if selected_employee_id and selected_employee_id == e.id %}selected{% endif %}>{{ e.user.username }}</option>
      {% endfor %}
    </select>
  </form>
</div>
<div class="grid grid-3">
  {% for m in months_data %}
    <div class="modern-card" style="padding:1rem;">
      <div style="font-weight:700;color:#2b6cb0;">{{ m.label }}</div>
      <div class="mini">Points: {{ m.points }} | Sales: ₹{{ m.amount|floatformat:0 }}</div>
      <div class="bar mt-2"><div class="bar-fill" style="width:{{ m.percent_of_max }}%;"></div></div>
      <div class="mt-2">
        <a href="{% url 'clients:admin_past_month_performance' m.year m.month %}" class="dashboard-link" style="padding:0.35rem 0.8rem;font-size:0.9rem;">View Month</a>
      </div>
    </div>
  {% endfor %}
</div>

<div class="section-title">Top Performers — {{ latest_month_label }}</div>
<div class="modern-card">
  {% if top_performers %}
    <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:0.75rem;">
      {% for t in top_performers %}
        <div style="border:1px solid #edf2f7; border-radius:12px; padding:0.8rem; box-shadow:0 1px 6px rgba(0,0,0,0.04);">
          <div style="font-weight:700;color:#2d3748;">{{ t.full_name }}</div>
          <div class="mini">Points: {{ t.total_points }}</div>
          <div class="mini">Sales: ₹{{ t.total_amount|floatformat:0 }}</div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted mb-0">No sales recorded for {{ latest_month_label }}.</p>
  {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function() {
    const labels = {{ labels_json|safe }};
    const data = {{ totals_json|safe }};
    const ctx = document.getElementById('adminPerformanceChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: '{{ chart_label }}',
          data: data,
          backgroundColor: 'rgba(66, 153, 225, 0.35)',
          borderColor: '#3182ce',
          borderWidth: 1.5,
          borderRadius: 6,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } }
      }
    });
  })();
</script>
{% endblock %}
