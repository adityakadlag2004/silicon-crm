{% extends "base.html" %}
{% block title %}Lead Management{% endblock %}
{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-1">Lead Management</h3>
    <div class="text-muted small">All leads you can access with progress in one place.</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-warning btn-sm" href="{% url 'clients:lead_create' %}">+ Add Lead</a>
    {% if can_see_stats %}
      <a class="btn btn-outline-dark btn-sm" href="{% url 'clients:lead_progress_admin' %}">Team Progress</a>
    {% endif %}
    {% if show_my_progress %}
      <a class="btn btn-outline-dark btn-sm" href="{% url 'clients:lead_progress_employee' %}">My Progress</a>
    {% endif %}
    {% if can_bulk_import %}
      <a class="btn btn-outline-primary btn-sm" href="{% url 'clients:lead_bulk_import' %}">Bulk Import</a>
    {% endif %}
  </div>
</div>

<form method="get" class="row g-2 align-items-center mb-3">
  <div class="col-sm-4">
    <input type="search" name="q" value="{{ search_term }}" class="form-control" placeholder="Search customer name" />
  </div>
  <div class="col-auto">
    <button class="btn btn-outline-dark btn-sm" type="submit">Search</button>
  </div>
</form>

<div class="d-flex gap-2 mb-3 flex-wrap">
  <a class="btn btn-sm {% if view_mode == 'current' %}btn-primary{% else %}btn-outline-secondary{% endif %}" href="?view=current">Current ({{ tab_counts.current }})</a>
  <a class="btn btn-sm {% if view_mode == 'completed' %}btn-primary{% else %}btn-outline-secondary{% endif %}" href="?view=completed">Completed ({{ tab_counts.completed }})</a>
  <a class="btn btn-sm {% if view_mode == 'discarded' %}btn-primary{% else %}btn-outline-secondary{% endif %}" href="?view=discarded">Discarded ({{ tab_counts.discarded }})</a>
  {% if show_my_tab %}
    <a class="btn btn-sm {% if view_mode == 'my' %}btn-primary{% else %}btn-outline-secondary{% endif %}" href="?view=my">My Leads ({{ tab_counts.my|default:0 }})</a>
  {% endif %}
</div>

<div class="table-responsive mb-4">
  <table class="table table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>Customer</th>
        <th>Assigned To</th>
        <th>Stage</th>
        <th>Data Received</th>
        <th>Health</th>
        <th>Life</th>
        <th>Wealth</th>
        <th>Updated</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for lead in leads %}
        <tr>
          <td>
            <div class="fw-semibold">{{ lead.customer_name }}</div>
            <div class="text-muted small">{{ lead.phone|default:"-" }}</div>
          </td>
          <td>{{ lead.assigned_to.user.username }}</td>
          <td><span class="badge bg-light text-dark border">{{ lead.get_stage_display }}</span></td>
          <td>
            {% if lead.data_received %}
              <span class="badge bg-success">Yes</span>
              {% if lead.data_received_on %}<div class="small text-muted">{{ lead.data_received_on }}</div>{% endif %}
            {% else %}
              <span class="badge bg-secondary">No</span>
            {% endif %}
          </td>
          {% with health=lead.progress_map.health %}
            <td>
              {% if health %}
                <div class="fw-semibold">{{ health.get_status_display }}</div>
                {% with target=health.target_amount|default_if_none:0 achieved=health.achieved_amount|default_if_none:0 %}
                  {% if target %}
                    {% widthratio achieved target 100 as health_completion %}
                    <div class="small text-muted">Target ₹{{ target|floatformat:0 }} | Ach ₹{{ achieved|floatformat:0 }} | {{ health_completion }}%</div>
                    <div class="progress" style="height:6px;">
                      <div class="progress-bar bg-success" role="progressbar" style="width: {{ health_completion }}%;" aria-valuenow="{{ health_completion }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  {% else %}
                    <div class="small text-muted">Target - | Ach ₹{{ achieved|floatformat:0 }}</div>
                    <div class="progress" style="height:6px;">
                      <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  {% endif %}
                {% endwith %}
              {% else %}<span class="text-muted">-</span>{% endif %}
            </td>
          {% endwith %}
          {% with life=lead.progress_map.life %}
            <td>
              {% if life %}
                <div class="fw-semibold">{{ life.get_status_display }}</div>
                {% with target=life.target_amount|default_if_none:0 achieved=life.achieved_amount|default_if_none:0 %}
                  {% if target %}
                    {% widthratio achieved target 100 as life_completion %}
                    <div class="small text-muted">Target ₹{{ target|floatformat:0 }} | Ach ₹{{ achieved|floatformat:0 }} | {{ life_completion }}%</div>
                    <div class="progress" style="height:6px;">
                      <div class="progress-bar bg-success" role="progressbar" style="width: {{ life_completion }}%;" aria-valuenow="{{ life_completion }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  {% else %}
                    <div class="small text-muted">Target - | Ach ₹{{ achieved|floatformat:0 }}</div>
                    <div class="progress" style="height:6px;">
                      <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  {% endif %}
                {% endwith %}
              {% else %}<span class="text-muted">-</span>{% endif %}
            </td>
          {% endwith %}
          {% with wealth=lead.progress_map.wealth %}
            <td>
              {% if wealth %}
                <div class="fw-semibold">{{ wealth.get_status_display }}</div>
                {% with target=wealth.target_amount|default_if_none:0 achieved=wealth.achieved_amount|default_if_none:0 %}
                  {% if target %}
                    {% widthratio achieved target 100 as wealth_completion %}
                    <div class="small text-muted">Target ₹{{ target|floatformat:0 }} | Ach ₹{{ achieved|floatformat:0 }} | {{ wealth_completion }}%</div>
                    <div class="progress" style="height:6px;">
                      <div class="progress-bar bg-success" role="progressbar" style="width: {{ wealth_completion }}%;" aria-valuenow="{{ wealth_completion }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  {% else %}
                    <div class="small text-muted">Target - | Ach ₹{{ achieved|floatformat:0 }}</div>
                    <div class="progress" style="height:6px;">
                      <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  {% endif %}
                {% endwith %}
              {% else %}<span class="text-muted">-</span>{% endif %}
            </td>
          {% endwith %}
          <td class="small text-muted">{{ lead.updated_at|date:"Y-m-d H:i" }}</td>
          <td class="text-end">
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">⋯</button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{% url 'clients:lead_detail' lead.id %}">Open lead</a></li>
                <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#followupModal" data-lead-id="{{ lead.id }}" data-lead-name="{{ lead.customer_name }}">Add next follow-up</button></li>
                <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#remarkModal" data-lead-id="{{ lead.id }}" data-lead-name="{{ lead.customer_name }}">Add remark</button></li>
                <li>
                  <form method="post" action="{% url 'clients:lead_mark_complete' lead.id %}">
                    {% csrf_token %}
                    <button type="submit" class="dropdown-item">Mark completed</button>
                  </form>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <form method="post" action="{% url 'clients:lead_discard' lead.id %}" onsubmit="return confirm('Discard this lead?');">
                    {% csrf_token %}
                    <button type="submit" class="dropdown-item text-danger">Discard lead</button>
                  </form>
                </li>
              </ul>
            </div>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="9" class="text-center text-muted">No leads found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Follow-up Modal -->
<div class="modal fade" id="followupModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add next follow-up</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" id="followupForm">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">When to reach</label>
            <input type="datetime-local" name="scheduled_time" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Notes (optional)</label>
            <textarea name="note" class="form-control" rows="2"></textarea>
          </div>
          <div class="text-muted small" id="followupLeadLabel"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Remark Modal -->
<div class="modal fade" id="remarkModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add remark</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" id="remarkForm">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Remark</label>
            <textarea name="text" class="form-control" rows="3" required></textarea>
          </div>
          <div class="text-muted small" id="remarkLeadLabel"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add remark</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const followupModal = document.getElementById('followupModal');
  if (followupModal) {
    followupModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const leadId = button.getAttribute('data-lead-id');
      const leadName = button.getAttribute('data-lead-name');
      const form = document.getElementById('followupForm');
      form.action = `{% url 'clients:lead_add_followup' 0 %}`.replace('/0/', `/${leadId}/`);
      document.getElementById('followupLeadLabel').textContent = `Lead: ${leadName}`;
    });
  }

  const remarkModal = document.getElementById('remarkModal');
  if (remarkModal) {
    remarkModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const leadId = button.getAttribute('data-lead-id');
      const leadName = button.getAttribute('data-lead-name');
      const form = document.getElementById('remarkForm');
      form.action = `{% url 'clients:lead_add_remark' 0 %}`.replace('/0/', `/${leadId}/`);
      document.getElementById('remarkLeadLabel').textContent = `Lead: ${leadName}`;
    });
  }
</script>

{% if progress_counts %}
<div class="row g-3">
  <div class="col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light">Stage Summary</div>
      <div class="card-body">
        <div class="d-flex justify-content-between"><span>Pending</span><span class="fw-semibold">{{ stage_counts.pending }}</span></div>
        <div class="d-flex justify-content-between"><span>Half Sold</span><span class="fw-semibold">{{ stage_counts.half_sold }}</span></div>
        <div class="d-flex justify-content-between"><span>Processed</span><span class="fw-semibold">{{ stage_counts.processed }}</span></div>
      </div>
    </div>
  </div>
  <div class="col-md-8">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light">Lead Completion Statistics</div>
      <div class="card-body p-0">
        <table class="table mb-0">
          <thead class="table-light">
            <tr>
              <th>Product</th>
              <th>Pending</th>
              <th>Half Sold</th>
              <th>Processed</th>
            </tr>
          </thead>
          <tbody>
            {% for product, statuses in progress_counts.items %}
              <tr>
                <td class="fw-semibold text-capitalize">{{ product }}</td>
                <td>{{ statuses.pending|default:0 }}</td>
                <td>{{ statuses.half_sold|default:0 }}</td>
                <td>{{ statuses.processed|default:0 }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-center text-muted">No progress data.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}
