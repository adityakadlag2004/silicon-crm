{% extends "base.html" %}
{% block title %}Lead Progress{% endblock %}
{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-1">{{ scope_label }}</h3>
    <div class="text-muted small">Stage and product completion snapshot.</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'clients:lead_management' %}">Back to Leads</a>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light">Stage Progress</div>
      <div class="card-body">
        {% with pending=stage_counts.pending|default:0 half=stage_counts.half_sold|default:0 processed=stage_counts.processed|default:0 %}
          {% with pending_pct=stage_pct.pending|default:0 half_pct=stage_pct.half_sold|default:0 processed_pct=stage_pct.processed|default:0 %}
            {% with total_val=pending|add:half|add:processed %}
              {% if total_val == 0 %}
                <div class="text-muted">No leads available.</div>
              {% else %}
                <div class="mb-2">
                  <div class="d-flex justify-content-between"><span>Pending</span><span class="fw-semibold">{{ pending }} ({{ pending_pct|floatformat:1 }}%)</span></div>
                  <div class="progress" style="height:10px;">
                    <div class="progress-bar" role="progressbar" style="width: {{ pending_pct }}%" aria-valuenow="{{ pending_pct }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
                <div class="mb-2">
                  <div class="d-flex justify-content-between"><span>Half Sold</span><span class="fw-semibold">{{ half }} ({{ half_pct|floatformat:1 }}%)</span></div>
                  <div class="progress" style="height:10px;">
                    <div class="progress-bar bg-warning" role="progressbar" style="width: {{ half_pct }}%" aria-valuenow="{{ half_pct }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
                <div class="mb-2">
                  <div class="d-flex justify-content-between"><span>Processed</span><span class="fw-semibold">{{ processed }} ({{ processed_pct|floatformat:1 }}%)</span></div>
                  <div class="progress" style="height:10px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ processed_pct }}%" aria-valuenow="{{ processed_pct }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              {% endif %}
            {% endwith %}
          {% endwith %}
        {% endwith %}
      </div>
    </div>
  </div>

  {% if per_employee %}
  <div class="col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light">By Employee</div>
      <div class="card-body p-0">
        <table class="table mb-0">
          <thead class="table-light">
            <tr>
              <th>Employee</th>
              <th>Pending</th>
              <th>Half</th>
              <th>Processed</th>
              <th>Sales (Approved)</th>
            </tr>
          </thead>
          <tbody>
            {% for row in per_employee %}
              {% with total_row=row.pending|add:row.half|add:row.processed %}
                <tr>
                  <td>{{ row.assigned_to__user__username }}</td>
                  <td>{{ row.pending }}</td>
                  <td>{{ row.half }}</td>
                  <td>{{ row.processed }}</td>
                  <td>â‚¹{{ row.total_sales|default:0|floatformat:0 }}</td>
                </tr>
              {% endwith %}
            {% empty %}
              <tr><td colspan="5" class="text-center text-muted">No data.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<div class="card shadow-sm">
  <div class="card-header bg-light">Product Completion</div>
  <div class="card-body p-0">
    <table class="table mb-0">
      <thead class="table-light">
        <tr>
          <th>Product</th>
          <th>Pending</th>
          <th>Half Sold</th>
          <th>Processed</th>
        </tr>
      </thead>
      <tbody>
        {% if progress_map %}
          {% for product, statuses in progress_map.items %}
            <tr>
              <td class="fw-semibold text-capitalize">{{ product }}</td>
              <td>{{ statuses.pending|default:0 }}</td>
              <td>{{ statuses.half_sold|default:0 }}</td>
              <td>{{ statuses.processed|default:0 }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="4" class="text-center text-muted">No progress data.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% if personal_stage %}
<div class="mt-3 card shadow-sm">
  <div class="card-header bg-light">My Leads Snapshot</div>
  <div class="card-body">
    {% with pending=personal_stage.pending|default:0 half=personal_stage.half_sold|default:0 processed=personal_stage.processed|default:0 %}
      {% with pending_pct=personal_stage_pct.pending|default:0 half_pct=personal_stage_pct.half_sold|default:0 processed_pct=personal_stage_pct.processed|default:0 %}
        {% with total_val=pending|add:half|add:processed %}
          {% if total_val == 0 %}
            <div class="text-muted">No personal leads available.</div>
          {% else %}
            <div class="mb-2">
              <div class="d-flex justify-content-between"><span>Pending</span><span class="fw-semibold">{{ pending }} ({{ pending_pct|floatformat:1 }}%)</span></div>
              <div class="progress" style="height:10px;">
                <div class="progress-bar bg-secondary" role="progressbar" style="width: {{ pending_pct }}%" aria-valuenow="{{ pending_pct }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>
            <div class="mb-2">
              <div class="d-flex justify-content-between"><span>Half Sold</span><span class="fw-semibold">{{ half }} ({{ half_pct|floatformat:1 }}%)</span></div>
              <div class="progress" style="height:10px;">
                <div class="progress-bar bg-warning" role="progressbar" style="width: {{ half_pct }}%" aria-valuenow="{{ half_pct }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>
            <div class="mb-2">
              <div class="d-flex justify-content-between"><span>Processed</span><span class="fw-semibold">{{ processed }} ({{ processed_pct|floatformat:1 }}%)</span></div>
              <div class="progress" style="height:10px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ processed_pct }}%" aria-valuenow="{{ processed_pct }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>
          {% endif %}
        {% endwith %}
      {% endwith %}
    {% endwith %}
  </div>
</div>
{% endif %}
{% endblock %}
