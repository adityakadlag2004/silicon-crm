{% extends "base.html" %}
{% block title %}My Clients{% endblock %}
{% block content %}
<style>
  .dashboard-section-title { font-size: 1.2rem; font-weight: 700; color: #2d3748; margin: 1.5rem 0 1rem; }
  .modern-card { background: #fff; border-radius: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); padding: 1rem; margin-bottom: 1rem; }
  .filter-bar { display:flex; flex-wrap:wrap; gap: 0.75rem; align-items:flex-end; }
  .filter-bar .form-label { font-size: 0.95rem; color:#4a5568; margin-bottom: 0.2rem; }
  .filter-bar .form-select, .filter-bar .form-control { border-radius: 10px; border:1px solid #e2e8f0; background:#f8fafc; font-size:0.95rem; padding:0.45rem 0.75rem; }
  .filter-toggle { font-size:0.95rem; font-weight:700; color:#e53935; cursor:pointer; display:inline-flex; align-items:center; gap:0.35rem; }
  .filter-accordion { display:none; margin-top:0.75rem; padding-top:0.75rem; border-top:1px dashed #e2e8f0; }
  .btn-primary-soft { background: linear-gradient(90deg, #f6e05e 0%, #fbd38d 100%); color:#1a202c; border:none; border-radius:10px; padding:0.55rem 1.1rem; font-weight:700; box-shadow:0 4px 12px rgba(0,0,0,0.08); text-decoration:none; }
  .btn-ghost { background:#f8fafc; color:#2d3748; border:1px solid #e2e8f0; border-radius:10px; padding:0.55rem 1.1rem; font-weight:700; text-decoration:none; }
  .table-wrap { overflow-x:auto; }
  table.clients-table { width:100%; border-collapse:collapse; font-size:0.97rem; background:#fff; border-radius:14px; overflow:hidden; }
  table.clients-table thead th { position:sticky; top:0; background:linear-gradient(90deg,#f6e05e 0%, #fbd38d 100%); color:#1a202c; padding:0.65rem 0.55rem; font-weight:800; border-bottom:2px solid #e2e8f0; z-index:1; text-align:left; }
  table.clients-table tbody tr:nth-child(odd) { background:#f9fbfd; }
  table.clients-table td { padding:0.65rem 0.55rem; border-bottom:1px solid #eef2f7; color:#2d3748; }
  .chip-btn { display:inline-flex; align-items:center; gap:0.3rem; padding:0.35rem 0.75rem; border-radius:999px; font-weight:700; border:1px solid #e2e8f0; background:#fff; color:#1a202c; text-decoration:none; box-shadow:0 1px 4px rgba(0,0,0,0.05); }
  .chip-btn:hover { background:#fff8e1; }
  .pager-wrap { display:flex; justify-content:flex-end; padding: 0.8rem 0; }
  .pagination { display:flex; gap:0.25rem; list-style:none; padding:0; margin:0; }
  .pagination .page-link { display:inline-block; padding:0.45rem 0.75rem; border-radius:8px; text-decoration:none; background:#fff; border:1px solid #e6e6e6; color:#2d3748; font-weight:600; }
  .pagination .page-item.active .page-link { background:#f6e05e; border-color:#ecc94b; }
  .pagination .page-item.disabled .page-link { opacity:0.5; pointer-events:none; }
  @media (max-width: 800px) {
    .filter-bar { flex-direction:column; align-items:stretch; }
  }
</style>

<div class="dashboard-section-title">My Clients</div>

<div class="modern-card mb-4">
  <form method="get" class="filter-bar">
    <div>
      <label class="form-label">SIP</label>
      <select name="sip_status" class="form-select">
        <option value="">All</option>
        <option value="yes" {% if request.GET.sip_status == "yes" %}selected{% endif %}>Yes</option>
        <option value="no" {% if request.GET.sip_status == "no" %}selected{% endif %}>No</option>
      </select>
    </div>
    <div>
      <label class="form-label">PMS</label>
      <select name="pms_status" class="form-select">
        <option value="">All</option>
        <option value="yes" {% if request.GET.pms_status == "yes" %}selected{% endif %}>Yes</option>
        <option value="no" {% if request.GET.pms_status == "no" %}selected{% endif %}>No</option>
      </select>
    </div>
    <div>
      <label class="form-label">Life</label>
      <select name="life_status" class="form-select">
        <option value="">All</option>
        <option value="yes" {% if request.GET.life_status == "yes" %}selected{% endif %}>Yes</option>
        <option value="no" {% if request.GET.life_status == "no" %}selected{% endif %}>No</option>
      </select>
    </div>
    <div style="display:flex;gap:0.6rem;align-items:center;flex-wrap:wrap;">
      <button type="submit" class="btn-primary-soft">Filter</button>
      <a href="{% url 'clients:my_clients' %}" class="btn-ghost">Reset</a>
      <span class="filter-toggle" id="moreFiltersToggle">More filters ▾</span>
    </div>

    <div class="filter-accordion" id="moreFiltersSection">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:0.75rem;">
        <div>
          <label class="form-label">SIP Min</label>
          <input type="number" name="sip_min" class="form-control" value="{{ request.GET.sip_min }}">
        </div>
        <div>
          <label class="form-label">SIP Max</label>
          <input type="number" name="sip_max" class="form-control" value="{{ request.GET.sip_max }}">
        </div>
        <div>
          <label class="form-label">PMS Min</label>
          <input type="number" name="pms_min" class="form-control" value="{{ request.GET.pms_min }}">
        </div>
        <div>
          <label class="form-label">PMS Max</label>
          <input type="number" name="pms_max" class="form-control" value="{{ request.GET.pms_max }}">
        </div>
        <div>
          <label class="form-label">Life Min</label>
          <input type="number" name="life_min" class="form-control" value="{{ request.GET.life_min }}">
        </div>
        <div>
          <label class="form-label">Life Max</label>
          <input type="number" name="life_max" class="form-control" value="{{ request.GET.life_max }}">
        </div>
        <div>
          <label class="form-label">Health</label>
          <select name="health_status" class="form-select">
            <option value="">All</option>
            <option value="yes" {% if request.GET.health_status == "yes" %}selected{% endif %}>Yes</option>
            <option value="no" {% if request.GET.health_status == "no" %}selected{% endif %}>No</option>
          </select>
        </div>
        <div>
          <label class="form-label">Health Min</label>
          <input type="number" name="health_min" class="form-control" value="{{ request.GET.health_min }}">
        </div>
        <div>
          <label class="form-label">Health Max</label>
          <input type="number" name="health_max" class="form-control" value="{{ request.GET.health_max }}">
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Bulk Messaging Controls -->
<div class="modern-card mb-3" style="display:flex;flex-wrap:wrap;gap:0.75rem;align-items:center;justify-content:space-between;">
  <div style="display:flex;align-items:center;gap:0.6rem;flex-wrap:wrap;">
    <label style="display:flex;align-items:center;gap:0.4rem;">
      <input id="selectAllClients" type="checkbox" />
      <small>Select all</small>
    </label>
    <select id="messageTemplateSelect" class="form-select" style="min-width:260px;">
      <option value="">Select message template...</option>
      {% for tpl in templates %}
        <option value="{{ tpl.id }}">{{ tpl.name }}</option>
      {% endfor %}
    </select>
    <button id="previewTemplateBtn" class="dashboard-link" type="button" style="padding:0.4rem 0.9rem;">Preview</button>
    <button id="sendWhatsAppBtn" class="dashboard-link" type="button" style="padding:0.4rem 0.9rem;">Send WhatsApp</button>
  </div>
  <div id="bulkStatus" style="font-size:0.95rem;color:#374151;display:none;"></div>
</div>

<div class="modern-card table-wrap">
  <table class="clients-table">
    <thead>
      <tr>
        <th style="width:38px;"><input id="colSelectAll" type="checkbox" /></th>
        <th>Name</th>
        <th>Phone</th>
        <th>Email</th>
        <th>SIP</th>
        <th>PMS</th>
        <th>Mapped To</th>
        <th style="width:140px;">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for client in clients_page %}
      <tr>
        <td><input class="client-select" type="checkbox" value="{{ client.id }}" data-phone="{{ client.phone|default:''|floatformat:0 }}" data-name="{{ client.name|escape }}" /></td>
        <td>{{ client.name }}</td>
        <td>{{ client.phone|default:''|floatformat:0 }}</td>
        <td>{{ client.email }}</td>
        <td>₹{{ client.sip_amount|default:0 }}</td>
        <td>₹{{ client.pms_amount|default:0 }}</td>
        <td>{% if client.mapped_to %}{{ client.mapped_to.user.username }}{% else %}-{% endif %}</td>
        <td style="display:flex;gap:0.35rem;flex-wrap:wrap;">
          <a href="{% url 'clients:edit_client' client.id %}" class="chip-btn">Edit</a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="8" class="text-center">No clients found</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="pager-wrap">
    <nav aria-label="Page navigation">
      <ul class="pagination">
        {% if clients_page.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ clients_page.previous_page_number }}{% if base_qs %}&{{ base_qs }}{% endif %}">Prev</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Prev</span></li>
        {% endif %}

        {% if 1 not in page_range %}
          <li class="page-item"><a class="page-link" href="?page=1{% if base_qs %}&{{ base_qs }}{% endif %}">1</a></li>
          {% if 2 not in page_range %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
        {% endif %}

        {% for p in page_range %}
          {% if p == clients_page.number %}
            <li class="page-item active"><span class="page-link">{{ p }}</span></li>
          {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ p }}{% if base_qs %}&{{ base_qs }}{% endif %}">{{ p }}</a></li>
          {% endif %}
        {% endfor %}

        {% if total_pages not in page_range %}
          {% if total_pages|add:-1 not in page_range %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
          <li class="page-item"><a class="page-link" href="?page={{ total_pages }}{% if base_qs %}&{{ base_qs }}{% endif %}">{{ total_pages }}</a></li>
        {% endif %}

        {% if clients_page.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ clients_page.next_page_number }}{% if base_qs %}&{{ base_qs }}{% endif %}">Next</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>

<!-- Preview / Send Modal (hidden by default) -->
<div id="bulkModal" style="display:none;position:fixed;inset:0;z-index:1200;align-items:center;justify-content:center;">
  <div style="width:94%;max-width:800px;background:#fff;border-radius:12px;padding:1rem;box-shadow:0 8px 40px rgba(0,0,0,0.25);margin:auto;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.6rem;">
      <strong id="bulkModalTitle">Preview messages</strong>
      <button id="bulkModalClose" class="dashboard-link" style="padding:0.25rem 0.6rem;font-size:0.9rem;">Close</button>
    </div>

    <div id="bulkModalBody" style="max-height:420px;overflow:auto;padding:0.4rem;border-radius:8px;background:#f8fafc;"></div>

    <div style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:0.6rem;">
      <button id="bulkModalSend" class="dashboard-link" style="padding:0.45rem 0.9rem;">Send now</button>
      <button id="bulkModalCancel" class="dashboard-link" style="background:#e2e8f0;color:#2d3748;padding:0.45rem 0.9rem;">Cancel</button>
    </div>
  </div>
</div>

<script>
// Toggle more filters accordion
const toggle = document.getElementById('moreFiltersToggle');
const moreFilters = document.getElementById('moreFiltersSection');
if (toggle && moreFilters) {
  toggle.addEventListener('click', function(){
    const isOpen = moreFilters.style.display === 'block';
    moreFilters.style.display = isOpen ? 'none' : 'block';
    toggle.textContent = isOpen ? 'More filters ▾' : 'Hide filters ▴';
  });
}

(function(){
  // CSRF cookie helper
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  const colSelectAll = document.getElementById('colSelectAll');
  const selectAll = document.getElementById('selectAllClients');
  const templateSelect = document.getElementById('messageTemplateSelect');
  const previewBtn = document.getElementById('previewTemplateBtn');
  const sendBtn = document.getElementById('sendWhatsAppBtn');
  const bulkStatus = document.getElementById('bulkStatus');
  const modal = document.getElementById('bulkModal');
  const modalBody = document.getElementById('bulkModalBody');
  const modalTitle = document.getElementById('bulkModalTitle');
  const modalClose = document.getElementById('bulkModalClose');
  const modalCancel = document.getElementById('bulkModalCancel');
  const modalSend = document.getElementById('bulkModalSend');

  function clientCheckboxes() {
    return Array.from(document.querySelectorAll('.client-select'));
  }

  if (colSelectAll) {
    colSelectAll.addEventListener('change', function(){ clientCheckboxes().forEach(cb=>cb.checked = this.checked); });
  }
  if (selectAll) {
    selectAll.addEventListener('change', function(){ clientCheckboxes().forEach(cb=>cb.checked = this.checked); });
  }

  function getSelectedClients() {
    return clientCheckboxes().filter(cb=>cb.checked).map(cb=>{
      // sanitize phone: strip trailing .0 (from float storage) and whitespace
      let raw = (cb.dataset.phone || '').toString().trim();
      raw = raw.replace(/\.0+$/,'');
      if (/e\+/i.test(raw)) {
        try { raw = (Number(raw)).toString().replace(/\.0+$/,''); } catch(e) {}
      }
      return { id: cb.value, name: cb.dataset.name || '', phone: raw };
    });
  }

  async function postBulk(data){
    const res = await fetch("{% url 'clients:bulk_whatsapp' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify(data)
    });
    return res;
  }

  previewBtn && previewBtn.addEventListener('click', async function(){
    const tpl = templateSelect.value;
    const clients = getSelectedClients();
    if (!tpl) return alert('Select a message template.');
    if (!clients.length) return alert('Select at least one client.');
    modalTitle.innerText = `Preview (${clients.length} clients)`;
    modalBody.innerHTML = `<div style="padding:0.6rem">Generating previews...</div>`;
    modal.style.display = 'flex';
    try {
      const res = await postBulk({ template_id: parseInt(tpl), client_ids: clients.map(c=>parseInt(c.id)), preview: true });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Server error');
      modalBody.innerHTML = '';
      const previews = data.messages_preview || [];
      if (!previews.length) {
        let msgHtml = `<div style="padding:0.6rem;color:#374151;">No preview messages were generated.`;
        if (data.skipped && data.skipped.length) {
          msgHtml += `<div class="small text-muted">Skipped (invalid/no phone): ` + data.skipped.map(s=>s.name).join(', ') + `</div>`;
        }
        msgHtml += `</div>`;
        modalBody.innerHTML = msgHtml;
      } else {
        previews.forEach(m=>{
          const el = document.createElement('div');
          el.style.padding = '0.6rem';
          el.style.borderBottom = '1px solid #e6eef6';
          el.innerHTML = `<strong>${m.client}</strong> — <small>${m.phone}</small>
                          <pre style="white-space:pre-wrap;margin:0.45rem 0 0 0;font-family:inherit;">${m.message}</pre>`;
          modalBody.appendChild(el);
        });
      }
      const openBtn = document.createElement('button');
      openBtn.className = 'dashboard-link';
      openBtn.style.marginTop = '0.6rem';
      openBtn.innerText = 'Open Drafts (WhatsApp)';
      openBtn.addEventListener('click', function(){
        if (!data.messages_preview || !data.messages_preview.length) return alert('No messages to open');
        data.messages_preview.forEach((msg)=>{
          const text = encodeURIComponent(msg.message);
          const wa = msg.wa_number || msg.phone.replace(/\D+/g, '');
          const url = `https://wa.me/${wa}?text=${text}`;
          window.open(url, '_blank');
        });
      });
      modalBody.appendChild(openBtn);
      // Open Next Draft (one-by-one)
      const openNext = document.createElement('button');
      openNext.className = 'btn btn-sm btn-outline-primary';
      openNext.style.marginLeft = '0.6rem';
      openNext.innerText = 'Open Next Draft';
      let openIdx = 0;
      openNext.addEventListener('click', function(){
        if (!data.messages_preview || !data.messages_preview.length) return alert('No messages to open');
        if (openIdx >= data.messages_preview.length) { alert('All drafts opened'); openIdx = 0; return; }
        const msg = data.messages_preview[openIdx++];
        const text = encodeURIComponent(msg.message);
        const wa = msg.wa_number || msg.phone.replace(/\D+/g, '');
        const url = `https://wa.me/${wa}?text=${text}`;
        window.open(url, '_blank');
      });
      modalBody.appendChild(openNext);
      // Links to preview page and CSV
      const actionsRow = document.createElement('div');
      actionsRow.style.marginTop = '0.8rem';
  const ids = (data.messages_preview || []).map(m=>m.id).join(',');
      const previewUrl = `{% url 'clients:wa_preview_page' %}?template_id=${tpl}&client_ids=${ids}`;
      const csvUrl = `{% url 'clients:wa_preview_csv' %}?template_id=${tpl}&client_ids=${ids}`;
      const a1 = document.createElement('a'); a1.href = previewUrl; a1.target = '_blank'; a1.className='btn btn-sm btn-secondary ms-2'; a1.innerText='Open Preview Page';
      const a2 = document.createElement('a'); a2.href = csvUrl; a2.target = '_blank'; a2.className='btn btn-sm btn-secondary ms-2'; a2.innerText='Download CSV';
      actionsRow.appendChild(a1); actionsRow.appendChild(a2);
      modalBody.appendChild(actionsRow);
    } catch(err){
      modalBody.innerHTML = `<div style="color:#9b2c2c;padding:0.6rem">Preview failed: ${err.message}</div>`;
    }
  });

  [modalClose, modalCancel].forEach(el=> el && el.addEventListener('click', ()=> modal.style.display='none'));

  modalSend && modalSend.addEventListener('click', async function(){
    const tpl = templateSelect.value;
    const clients = getSelectedClients();
    if (!tpl) return alert('Select a template.');
    if (!clients.length) return alert('Select clients.');
    modalBody.innerHTML = `<div style="padding:0.6rem">Sending messages... please wait.</div>`;
    modalSend.disabled = true;
    modalSend.innerText = 'Sending...';
    try {
      const res = await postBulk({ template_id: parseInt(tpl), client_ids: clients.map(c=>parseInt(c.id)) });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Server error');
      modalBody.innerHTML = `<div style="padding:0.6rem;color:green">Sent ${data.sent_count} messages.</div>`;
      (data.messages_preview || []).forEach(m=>{
        const el = document.createElement('div');
        el.style.padding = '0.5rem';
        el.style.borderTop = '1px solid #eef4fb';
        el.innerHTML = `<strong>${m.client}</strong> — <small>${m.phone}</small>
                        <pre style="white-space:pre-wrap;margin:0.3rem 0 0 0;font-family:inherit;">${m.message}</pre>`;
        modalBody.appendChild(el);
      });
      bulkStatus.style.display = 'block';
      bulkStatus.innerText = `Last sent: ${data.sent_count} messages`;
      setTimeout(()=> bulkStatus.style.opacity = 1, 10);
    } catch(err){
      modalBody.innerHTML = `<div style="color:#9b2c2c;padding:0.6rem">Send failed: ${err.message}</div>`;
    } finally {
      modalSend.disabled = false;
      modalSend.innerText = 'Send now';
    }
  });

  sendBtn && sendBtn.addEventListener('click', function(){ previewBtn.click(); });

})();
</script>

{% endblock %}
