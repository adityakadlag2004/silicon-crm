{% extends "base.html" %}
{% block title %}My Clients{% endblock %}
{% block content %}
<style>
  /* (same CSS as before) */
  .dashboard-section-title { font-size: 1.25rem; font-weight: 600; color: #2d3748; margin-bottom: 1rem; margin-top: 2rem; }
  .modern-card { background: #fff; border-radius: 18px; box-shadow: 0 2px 16px rgba(0,0,0,0.07); padding: 2rem 1.5rem; margin-bottom: 1.5rem; transition: box-shadow 0.2s; }
  .modern-card:hover { box-shadow: 0 4px 24px rgba(0,0,0,0.12); }
  .dashboard-link { display: inline-flex; align-items: center; padding: 0.7rem 1.5rem; border-radius: 12px; background: linear-gradient(90deg, #f6e05e 0%, #ecc94b 100%); color: #2d3748; font-weight: 600; text-decoration: none; box-shadow: 0 1px 6px rgba(0,0,0,0.07); transition: background 0.2s; }
  .dashboard-link:hover { background: linear-gradient(90deg, #ecc94b 0%, #f6e05e 100%); color: #1a202c; }
  .pager-wrap { display:flex; justify-content:flex-end; padding:1rem 0; }
  .pagination { display:flex; gap:0.25rem; list-style:none; padding:0; margin:0; }
  .pagination .page-link { display:inline-block; padding:0.45rem 0.75rem; border-radius:8px; text-decoration:none; background:#fff; border:1px solid #e6e6e6; color:#2d3748; font-weight:600; }
  .pagination .page-item.active .page-link { background:#f6e05e; border-color:#ecc94b; }
  .table { margin-bottom: 0; border-radius:12px; overflow:hidden; background:#fff; }
  .table thead th { background:#f6e05e; color:#2d3748; font-weight:600; border-bottom:2px solid #ecc94b; padding:0.7rem 0.5rem; text-align:left; }
  .table td { padding:0.6rem 0.5rem; border-top:1px solid #f7fafc; color:#2d3748; }
  .table-striped tbody tr:nth-of-type(odd) { background:#f7fafc; }
</style>

<div class="dashboard-section-title">My Clients</div>

<div class="modern-card mb-4">
  <form method="get" class="row g-3">
    <!-- Status Filters -->
    <div class="col-md-2">
      <label class="form-label">SIP</label>
      <select name="sip_status" class="form-select">
        <option value="">All</option>
        <option value="yes" {% if request.GET.sip_status == "yes" %}selected{% endif %}>Yes</option>
        <option value="no" {% if request.GET.sip_status == "no" %}selected{% endif %}>No</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">PMS</label>
      <select name="pms_status" class="form-select">
        <option value="">All</option>
        <option value="yes" {% if request.GET.pms_status == "yes" %}selected{% endif %}>Yes</option>
        <option value="no" {% if request.GET.pms_status == "no" %}selected{% endif %}>No</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Life</label>
      <select name="life_status" class="form-select">
        <option value="">All</option>
        <option value="yes" {% if request.GET.life_status == "yes" %}selected{% endif %}>Yes</option>
        <option value="no" {% if request.GET.life_status == "no" %}selected{% endif %}>No</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Health</label>
      <select name="health_status" class="form-select">
        <option value="">All</option>
        <option value="yes" {% if request.GET.health_status == "yes" %}selected{% endif %}>Yes</option>
        <option value="no" {% if request.GET.health_status == "no" %}selected{% endif %}>No</option>
      </select>
    </div>

    <!-- Range Filters -->
    <div class="col-md-2"><label class="form-label">SIP Min</label><input type="number" name="sip_min" class="form-control" value="{{ request.GET.sip_min }}"></div>
    <div class="col-md-2"><label class="form-label">SIP Max</label><input type="number" name="sip_max" class="form-control" value="{{ request.GET.sip_max }}"></div>
    <div class="col-md-2"><label class="form-label">PMS Min</label><input type="number" name="pms_min" class="form-control" value="{{ request.GET.pms_min }}"></div>
    <div class="col-md-2"><label class="form-label">PMS Max</label><input type="number" name="pms_max" class="form-control" value="{{ request.GET.pms_max }}"></div>
    <div class="col-md-2"><label class="form-label">Life Min</label><input type="number" name="life_min" class="form-control" value="{{ request.GET.life_min }}"></div>
    <div class="col-md-2"><label class="form-label">Life Max</label><input type="number" name="life_max" class="form-control" value="{{ request.GET.life_max }}"></div>
    <div class="col-md-2"><label class="form-label">Health Min</label><input type="number" name="health_min" class="form-control" value="{{ request.GET.health_min }}"></div>
    <div class="col-md-2"><label class="form-label">Health Max</label><input type="number" name="health_max" class="form-control" value="{{ request.GET.health_max }}"></div>

    <div class="col-md-12 mt-2">
      <button type="submit" class="dashboard-link">Filter</button>
      <a href="{% url 'clients:my_clients' %}" class="dashboard-link" style="background:linear-gradient(90deg,#e2e8f0 0%,#f7fafc 100%);color:#2d3748;">Reset</a>
    </div>
  </form>
</div>

<!-- Bulk Messaging Controls -->
<div class="modern-card mb-3" style="display:flex;flex-wrap:wrap;gap:0.75rem;align-items:center;justify-content:space-between;">
  <div style="display:flex;align-items:center;gap:0.6rem;flex-wrap:wrap;">
    <label style="display:flex;align-items:center;gap:0.4rem;">
      <input id="selectAllClients" type="checkbox" />
      <small>Select all</small>
    </label>
    <select id="messageTemplateSelect" class="form-select" style="min-width:260px;">
      <option value="">Select message template...</option>
      {% for tpl in templates %}
        <option value="{{ tpl.id }}">{{ tpl.name }}</option>
      {% endfor %}
    </select>
    <button id="previewTemplateBtn" class="dashboard-link" type="button" style="padding:0.4rem 0.9rem;">Preview</button>
    <button id="sendWhatsAppBtn" class="dashboard-link" type="button" style="padding:0.4rem 0.9rem;">Send WhatsApp</button>
  </div>
  <div id="bulkStatus" style="font-size:0.95rem;color:#374151;display:none;"></div>
</div>

<div class="modern-card">
  <table class="table table-striped">
    <thead>
      <tr>
        <th style="width:40px;"><input id="colSelectAll" type="checkbox" /></th>
        <th>#</th>
        <th>ID</th>
        <th>Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>SIP</th>
        <th>PMS</th>
        <th>Life Cover</th>
        <th>Health Cover</th>
        <th>Mapped To</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for client in clients_page %}
      <tr>
        <td><input class="client-select" type="checkbox" value="{{ client.id }}" /></td>
        <td>{{ clients_page.start_index|add:forloop.counter0 }}</td>
        <td>{{ client.id }}</td>
        <td>{{ client.name }}</td>
        <td>{{ client.email }}</td>
        <td>{{ client.phone }}</td>
        <td>₹{{ client.sip_amount|default:0 }}</td>
        <td>₹{{ client.pms_amount|default:0 }}</td>
        <td>₹{{ client.life_cover|default:0 }}</td>
        <td>₹{{ client.health_cover|default:0 }}</td>
        </td>
    
        <td>{% if client.mapped_to %}{{ client.mapped_to.user.username }}{% else %}-{% endif %}</td>
    <td>

  <a href="{% url 'clients:edit_client' client.id %}" class="btn btn-sm btn-warning">
    Edit
  </a>
        </td>
        
        </tr>
      {% empty %}
      <tr><td colspan="10" class="text-center">No clients found</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="pager-wrap">
    <nav aria-label="Page navigation">
      <ul class="pagination">
        {% if clients_page.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ clients_page.previous_page_number }}{% if base_qs %}&{{ base_qs }}{% endif %}">Prev</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Prev</span></li>
        {% endif %}

        {% if 1 not in page_range %}
          <li class="page-item"><a class="page-link" href="?page=1{% if base_qs %}&{{ base_qs }}{% endif %}">1</a></li>
          {% if 2 not in page_range %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
        {% endif %}

        {% for p in page_range %}
          {% if p == clients_page.number %}
            <li class="page-item active"><span class="page-link">{{ p }}</span></li>
          {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ p }}{% if base_qs %}&{{ base_qs }}{% endif %}">{{ p }}</a></li>
          {% endif %}
        {% endfor %}

        {% if total_pages not in page_range %}
          {% if total_pages|add:-1 not in page_range %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
          <li class="page-item"><a class="page-link" href="?page={{ total_pages }}{% if base_qs %}&{{ base_qs }}{% endif %}">{{ total_pages }}</a></li>
        {% endif %}

        {% if clients_page.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ clients_page.next_page_number }}{% if base_qs %}&{{ base_qs }}{% endif %}">Next</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>

<!-- Preview / Send Modal (hidden by default) -->
<div id="bulkModal" style="display:none;position:fixed;inset:0;z-index:1200;align-items:center;justify-content:center;">
  <div style="width:94%;max-width:800px;background:#fff;border-radius:12px;padding:1rem;box-shadow:0 8px 40px rgba(0,0,0,0.25);margin:auto;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.6rem;">
      <strong id="bulkModalTitle">Preview messages</strong>
      <button id="bulkModalClose" class="dashboard-link" style="padding:0.25rem 0.6rem;font-size:0.9rem;">Close</button>
    </div>

    <div id="bulkModalBody" style="max-height:420px;overflow:auto;padding:0.4rem;border-radius:8px;background:#f8fafc;"></div>

    <div style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:0.6rem;">
      <button id="bulkModalSend" class="dashboard-link" style="padding:0.45rem 0.9rem;">Send now</button>
      <button id="bulkModalCancel" class="dashboard-link" style="background:#e2e8f0;color:#2d3748;padding:0.45rem 0.9rem;">Cancel</button>
    </div>
  </div>
</div>

<script>
(function(){
  // CSRF cookie helper
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  const colSelectAll = document.getElementById('colSelectAll');
  const selectAll = document.getElementById('selectAllClients');
  const templateSelect = document.getElementById('messageTemplateSelect');
  const previewBtn = document.getElementById('previewTemplateBtn');
  const sendBtn = document.getElementById('sendWhatsAppBtn');
  const bulkStatus = document.getElementById('bulkStatus');
  const modal = document.getElementById('bulkModal');
  const modalBody = document.getElementById('bulkModalBody');
  const modalTitle = document.getElementById('bulkModalTitle');
  const modalClose = document.getElementById('bulkModalClose');
  const modalCancel = document.getElementById('bulkModalCancel');
  const modalSend = document.getElementById('bulkModalSend');

  function clientCheckboxes() {
    return Array.from(document.querySelectorAll('.client-select'));
  }

  if (colSelectAll) {
    colSelectAll.addEventListener('change', function(){ clientCheckboxes().forEach(cb=>cb.checked = this.checked); });
  }
  if (selectAll) {
    selectAll.addEventListener('change', function(){ clientCheckboxes().forEach(cb=>cb.checked = this.checked); });
  }

  function getSelectedClients() {
    return clientCheckboxes().filter(cb=>cb.checked).map(cb=>{
      const tr = cb.closest('tr');
      const tds = tr ? tr.querySelectorAll('td') : [];
      let name = '';
      let phone = '';
      if (tds.length) {
        for (let i=0;i<tds.length;i++){
          const text = tds[i].innerText.trim();
          if (!phone && /^[0-9\+\-\s]{6,}$/.test(text)) { phone = text; continue; }
          if (!name && text && !/^[0-9\+\-\s]{6,}$/.test(text)) { name = text; continue; }
        }
      }
      return { id: cb.value, name: name, phone: phone };
    });
  }

  async function postBulk(data){
    const res = await fetch("{% url 'clients:bulk_whatsapp' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify(data)
    });
    return res;
  }

  previewBtn && previewBtn.addEventListener('click', async function(){
    const tpl = templateSelect.value;
    const clients = getSelectedClients();
    if (!tpl) return alert('Select a message template.');
    if (!clients.length) return alert('Select at least one client.');
    modalTitle.innerText = `Preview (${clients.length} clients)`;
    modalBody.innerHTML = `<div style="padding:0.6rem">Generating previews...</div>`;
    modal.style.display = 'flex';
    try {
      const res = await postBulk({ template_id: parseInt(tpl), client_ids: clients.map(c=>parseInt(c.id)), preview: true });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Server error');
      modalBody.innerHTML = '';
      (data.messages_preview || []).forEach(m=>{
        const el = document.createElement('div');
        el.style.padding = '0.6rem';
        el.style.borderBottom = '1px solid #e6eef6';
        el.innerHTML = `<strong>${m.client}</strong> — <small>${m.phone}</small>
                        <pre style="white-space:pre-wrap;margin:0.45rem 0 0 0;font-family:inherit;">${m.message}</pre>`;
        modalBody.appendChild(el);
      });
    } catch(err){
      modalBody.innerHTML = `<div style="color:#9b2c2c;padding:0.6rem">Preview failed: ${err.message}</div>`;
    }
  });

  [modalClose, modalCancel].forEach(el=> el && el.addEventListener('click', ()=> modal.style.display='none'));

  modalSend && modalSend.addEventListener('click', async function(){
    const tpl = templateSelect.value;
    const clients = getSelectedClients();
    if (!tpl) return alert('Select a template.');
    if (!clients.length) return alert('Select clients.');
    modalBody.innerHTML = `<div style="padding:0.6rem">Sending messages... please wait.</div>`;
    modalSend.disabled = true;
    modalSend.innerText = 'Sending...';
    try {
      const res = await postBulk({ template_id: parseInt(tpl), client_ids: clients.map(c=>parseInt(c.id)) });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Server error');
      modalBody.innerHTML = `<div style="padding:0.6rem;color:green">Sent ${data.sent_count} messages.</div>`;
      (data.messages_preview || []).forEach(m=>{
        const el = document.createElement('div');
        el.style.padding = '0.5rem';
        el.style.borderTop = '1px solid #eef4fb';
        el.innerHTML = `<strong>${m.client}</strong> — <small>${m.phone}</small>
                        <pre style="white-space:pre-wrap;margin:0.3rem 0 0 0;font-family:inherit;">${m.message}</pre>`;
        modalBody.appendChild(el);
      });
      bulkStatus.style.display = 'block';
      bulkStatus.innerText = `Last sent: ${data.sent_count} messages`;
      setTimeout(()=> bulkStatus.style.opacity = 1, 10);
    } catch(err){
      modalBody.innerHTML = `<div style="color:#9b2c2c;padding:0.6rem">Send failed: ${err.message}</div>`;
    } finally {
      modalSend.disabled = false;
      modalSend.innerText = 'Send now';
    }
  });

  sendBtn && sendBtn.addEventListener('click', function(){ previewBtn.click(); });

})();
</script>

{% endblock %}
