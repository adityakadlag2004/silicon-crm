{% extends "base.html" %}
{% block title %}My Calendar{% endblock %}

{% block content %}
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<style>
  .calendar-card {
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    padding: 2.2rem 1.5rem 2rem 1.5rem;
    margin-bottom: 1.2rem;
    max-width: 1100px;
    margin-left: auto;
    margin-right: auto;
  }
  .calendar-card h2 {
    text-align: center;
    font-weight: 700;
    color: #1a202c;
    margin-bottom: 1.2rem;
    letter-spacing: 0.5px;
    text-shadow: 0 1px 4px rgba(236,201,75,0.12);
  }
  #calendar {
    max-width: 100%;
    margin: 0 auto;
    background: linear-gradient(120deg, #fffde7 0%, #f6e05e 100%);
    padding: 12px;
    border-radius: 12px;
    box-shadow: 0 1px 8px rgba(236,201,75,0.10);
    color: #1a202c;
  }
  .fc .fc-toolbar-title, .fc .fc-col-header-cell-cushion, .fc .fc-daygrid-day-number, .fc .fc-event-title {
    color: #1a202c !important;
    font-weight: 600;
    text-shadow: 0 1px 4px rgba(236,201,75,0.10);
  }
  .fc .fc-timegrid-slot-label {
    color: #ecc94b !important;
    font-weight: 700;
    background: #2d3748 !important;
    border-radius: 6px;
    padding: 2px 8px;
  }
  .fc .fc-daygrid-day {
    color: #2d3748 !important;
  }
  .fc-daygrid-day:hover { cursor: pointer; background-color: #f3f7fb; }
  .fc-customButton-backButton { background-color: #6c757d; color: #fff; border: none; }
  .modal-content {
    border-radius: 14px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  }
  @media (max-width: 1100px) {
    .calendar-card { padding: 1rem 0.2rem; max-width: 99vw; }
    #calendar { padding: 6px; }
  }
  @media (max-width: 600px) {
    .calendar-card { padding: 0.5rem 0.1rem; }
    #calendar { padding: 2px; }
    h2 { font-size: 1.1rem; }
    .fc .fc-toolbar.fc-header-toolbar { flex-direction: column; gap: 0.35rem; }
    .fc .fc-toolbar-chunk { width: 100%; justify-content: center; }
    .fc .fc-button-group { width: 100%; justify-content: center; flex-wrap: wrap; gap: 4px; }
    .fc .fc-button { flex: 1 1 80px; min-width: 80px; padding: 4px 6px; font-size: 0.85rem; }
    .d-flex.flex-wrap.justify-content-center.gap-2 { row-gap: 0.35rem; }
    .filter-row { overflow-x: auto; flex-wrap: nowrap !important; padding: 0 4px; }
    .filter-row::-webkit-scrollbar { height: 6px; }
    .filter-row::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 4px; }
    .filter-row .form-check-inline { margin-right: 0.35rem; white-space: nowrap; }
    .badge { font-size: 0.78rem; }
  }
  /* Ensure modals appear above FullCalendar overlays */
  .modal {
    z-index: 20500 !important;
  }
  .modal-backdrop {
    z-index: 20400 !important;
  }
</style>

<div class="calendar-card">
  <h2>ðŸ“… My Calendar</h2>
    <!-- Status chips -->
    <div class="d-flex flex-wrap justify-content-center gap-2 mb-3">
      <span class="badge rounded-pill bg-primary">Pending: {{ pending_count|default:0 }}</span>
      <span class="badge rounded-pill bg-danger">Missed: {{ missed_count|default:0 }}</span>
      <span class="badge rounded-pill bg-success">Completed: {{ completed_count|default:0 }}</span>
    </div>
  <!-- Legend / quick filters -->
    <div class="d-flex justify-content-center mb-3 gap-2 align-items-center flex-wrap filter-row">
    <label class="small mb-0 me-2">Show:</label>
    <div class="form-check form-check-inline">
      <input class="form-check-input evt-filter" type="checkbox" id="f_followup" value="call_followup" checked>
      <label class="form-check-label badge bg-success text-white" for="f_followup">Follow-up</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input evt-filter" type="checkbox" id="f_meeting" value="meeting" checked>
      <label class="form-check-label badge" style="background:#ecc94b; color:#2d3748;" for="f_meeting">Meeting</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input evt-filter" type="checkbox" id="f_reminder" value="reminder" checked>
      <label class="form-check-label badge bg-warning text-dark" for="f_reminder">Reminder</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input evt-filter" type="checkbox" id="f_other" value="task" checked>
      <label class="form-check-label badge bg-secondary text-white" for="f_other">Other</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input evt-filter" type="checkbox" id="f_bday" value="birthday" checked>
      <label class="form-check-label badge" style="background:#ff9ccf; color:#641e16;" for="f_bday">Birthday</label>
    </div>
  </div>
  <!-- Source filters -->
  <div class="d-flex justify-content-center mb-3 gap-2 align-items-center flex-wrap filter-row">
    <label class="small mb-0 me-2">Source:</label>
    <div class="form-check form-check-inline">
      <input class="form-check-input src-filter" type="checkbox" id="src_manual" value="manual" checked>
      <label class="form-check-label badge bg-secondary text-white" for="src_manual">Manual</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input src-filter" type="checkbox" id="src_calling" value="calling_list" checked>
      <label class="form-check-label badge bg-info text-dark" for="src_calling">Calling List</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input src-filter" type="checkbox" id="src_bday" value="birthday" checked>
      <label class="form-check-label badge" style="background:#ff9ccf; color:#641e16;" for="src_bday">Birthday</label>
    </div>
  </div>
  <!-- Status filters -->
  <div class="d-flex justify-content-center mb-3 gap-2 align-items-center flex-wrap filter-row">
    <label class="small mb-0 me-2">Status:</label>
    <div class="form-check form-check-inline">
      <input class="form-check-input status-filter" type="checkbox" id="st_pending" value="pending" checked>
      <label class="form-check-label badge bg-primary" for="st_pending">Pending</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input status-filter" type="checkbox" id="st_missed" value="missed" checked>
      <label class="form-check-label badge bg-danger" for="st_missed">Missed</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input status-filter" type="checkbox" id="st_completed" value="completed">
      <label class="form-check-label badge bg-success" for="st_completed">Completed</label>
    </div>
  </div>
  <div id="calendar"></div>
</div>

  <!-- Toast container -->
  <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 22000;"></div>

<!-- Event detail modal -->
<div class="modal fade" id="eventDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="modalWhen"></p>
        <p><strong>Type:</strong> <span id="modalType"></span></p>
        <p><strong>Notes:</strong></p>
        <p id="modalNotes"></p>
        <p id="modalProspect" style="display:none;">
          <strong>Prospect:</strong> <span id="modalProspectName"></span>
        </p>
      </div>
      <div class="modal-footer">
        <button id="modalBirthdayFollowup" type="button" class="btn btn-sm btn-warning" style="display:none;">Create Follow-up</button>
        <button id="eventDetailEdit" type="button" class="btn btn-sm btn-primary">Edit</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>

      <!-- Create / Quick Add Event Modal -->
      <div class="modal fade" id="createEventModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Create Event</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="createEventForm">
                <div class="mb-2">
                  <label class="form-label small">Title</label>
                  <input class="form-control form-control-sm" name="title" id="evt_title" required />
                </div>
                <div class="mb-2">
                  <label class="form-label small">When</label>
                  <input type="datetime-local" class="form-control form-control-sm" name="scheduled_time" id="evt_when" required />
                </div>
                <div class="mb-2">
                  <label class="form-label small">End</label>
                  <input type="datetime-local" class="form-control form-control-sm" name="end_time" id="evt_end" />
                </div>
                <div class="mb-2">
                  <label class="form-label small">Type</label>
                  <select class="form-select form-select-sm" id="evt_type" name="type">
                    <option value="call_followup">Call Follow-up</option>
                    <option value="meeting">Meeting</option>
                    <option value="task">Task</option>
                    <option value="reminder">Reminder</option>
                    <option value="call_followup">Birthday Call</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label small">Notes</label>
                  <textarea class="form-control form-control-sm" id="evt_notes" name="notes"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
              <button id="createEventSubmit" type="button" class="btn btn-primary btn-sm">Create</button>
            </div>
          </div>
        </div>
  </div>

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');

  const initialView = window.innerWidth < 700 ? 'timeGridDay' : 'dayGridMonth';

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: initialView,
    headerToolbar: {
      left: 'prev,next today,backButton',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
    },
    customButtons: {
      backButton: {
        text: 'Back to Month',
        click: function() {
          calendar.changeView('dayGridMonth');
        }
      }
    },
    navLinks: true,
    nowIndicator: true,
    selectable: true,

    // ðŸ”¹ Enable drag-drop & resize
    editable: true,
    eventDurationEditable: true,

    events: {
      url: "{% url 'clients:calendar_events_json' %}",
      extraParams: function() {
        const types = Array.from(document.querySelectorAll('.evt-filter:checked')).map(i=>i.value);
        const sources = Array.from(document.querySelectorAll('.src-filter:checked')).map(i=>i.value);
        const statuses = Array.from(document.querySelectorAll('.status-filter:checked')).map(i=>i.value);
        return {
          types: types.join(','),
          sources: sources.join(','),
          statuses: statuses.join(',')
        };
      },
      failure: function() {
        alert('There was an error while fetching events.');
      }
    },

    // ðŸ”¹ Event color coding
    // ðŸ”¹ Event color coding + missed highlighting
    eventDidMount: function(info) {
      const colorMap = {
        call_followup: {bg: '#28a745', fg: '#fff'},
        meeting: {bg: '#ecc94b', fg: '#2d3748'},
        reminder: {bg: '#fd7e14', fg: '#fff'},
        task: {bg: '#6c757d', fg: '#fff'},
        birthday: {bg: '#ff9ccf', fg: '#641e16'}
      };
      const type = info.event.extendedProps.type;
      const status = info.event.extendedProps.status;
      const cfg = colorMap[type] || colorMap['task'];
      info.el.style.backgroundColor = cfg.bg;
      info.el.style.borderColor = cfg.bg;
      info.el.style.color = cfg.fg;
      // expose event id on the element so right-click handlers can access it
      try { if (info.event && info.event.id) info.el.setAttribute('data-event-id', info.event.id); } catch (e) {}
      if (type === 'birthday' && info.el.querySelector('.fc-event-title')) {
        const titleEl = info.el.querySelector('.fc-event-title');
        titleEl.innerHTML = 'ðŸŽ‚ ' + titleEl.innerHTML;
      }
      // mark missed (pending but start in past) with red outline
      if (status === 'pending' && info.event.start && info.event.start < new Date()) {
        info.el.style.outline = '2px solid #e53e3e';
        info.el.style.boxShadow = '0 0 0 2px rgba(229,62,62,0.25)';
        info.el.title = (info.el.title || '') + ' (Missed)';
      }

      // Add source badge inline
      const source = info.event.extendedProps.source;
      if (source) {
        const badge = document.createElement('span');
        badge.className = 'ms-1 badge badge-sm';
        if (source === 'calling_list') {
          badge.className += ' bg-info text-dark';
          badge.innerText = 'Calling List';
        } else if (source === 'birthday') {
          badge.style.background = '#ff9ccf';
          badge.style.color = '#641e16';
          badge.innerText = 'Birthday';
        } else {
          badge.className += ' bg-secondary text-white';
          badge.innerText = 'Manual';
        }
        const titleEl = info.el.querySelector('.fc-event-title');
        if (titleEl) titleEl.appendChild(badge);
      }
    },

    // ðŸ”¹ Event drag/drop update
    eventDrop: function(info) {
      updateEventTime(info.event);
    },

    // ðŸ”¹ Event resize update
    eventResize: function(info) {
      updateEventTime(info.event);
    },

    // Click on event â†’ modal
    eventClick: function(info) {
      const ev = info.event;
      const props = ev.extendedProps || {};

      document.getElementById('modalTitle').innerText = ev.title;
      document.getElementById('modalWhen').innerText = new Date(ev.start).toLocaleString();
      document.getElementById('modalType').innerText = props.type || 'â€”';
      document.getElementById('modalNotes').innerText = props.notes || 'â€”';
        const sourceText = props.source === 'birthday' ? 'Birthday' : (props.source === 'calling_list' ? 'Calling List' : 'Manual');
        document.getElementById('modalType').innerText = `${props.type || 'â€”'} Â· ${sourceText}`;

      if (props.related_prospect_name) {
        document.getElementById('modalProspectName').innerText = props.related_prospect_name;
        document.getElementById('modalProspect').style.display = 'block';
      } else {
        document.getElementById('modalProspect').style.display = 'none';
      }

      // toggle birthday follow-up button and edit availability
      const followBtn = document.getElementById('modalBirthdayFollowup');
      const editBtn = document.getElementById('eventDetailEdit');
      const isBirthday = String(ev.id).startsWith('birth-');
      followBtn.style.display = isBirthday ? 'inline-block' : 'none';
      editBtn.style.display = isBirthday ? 'none' : 'inline-block';

      new bootstrap.Modal(document.getElementById('eventDetailModal')).show();
      // set editing id so Edit from detail modal will edit this event
      window.__editingEventId = isBirthday ? null : ev.id;
      updateCreateButtonLabel();
    },

    // Click on a day â†’ switch to Day view
    dateClick: function(info) {
      calendar.changeView('timeGridDay', info.dateStr);
    }
  });

  calendar.render();

  // ---------- Custom right-click context menu ----------
  const ctxMenu = document.createElement('div');
  ctxMenu.id = 'fc-ctx-menu';
  ctxMenu.style.position = 'absolute';
  ctxMenu.style.zIndex = 9999;
  ctxMenu.style.background = '#fff';
  ctxMenu.style.border = '1px solid rgba(0,0,0,0.08)';
  ctxMenu.style.borderRadius = '8px';
  ctxMenu.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';
  ctxMenu.style.display = 'none';
  ctxMenu.innerHTML = `
    <div class="list-group list-group-flush" style="min-width:200px;">
      <button class="list-group-item list-group-item-action" data-action="add_event">Add Event</button>
      <button class="list-group-item list-group-item-action" data-action="add_birthday">Add Birthday Call</button>
      <button class="list-group-item list-group-item-action" data-action="quick_followup">Quick Follow-up (+1d)</button>
      <button class="list-group-item list-group-item-action" data-action="edit_event" style="display:none;">Edit Event</button>
      <button class="list-group-item list-group-item-action text-danger" data-action="delete_event" style="display:none;">Delete Event</button>
    </div>
  `;
  document.body.appendChild(ctxMenu);

  // show custom menu on right-click inside calendar
  calendarEl.addEventListener('contextmenu', function(ev) {
    ev.preventDefault();
    const x = ev.pageX;
    const y = ev.pageY;
    ctxMenu.style.left = x + 'px';
    ctxMenu.style.top = y + 'px';
    // detect if right-clicked on an event element
    const evEl = ev.target.closest('.fc-event');
    if (evEl) {
      // set dataset to indicate event context
      const eid = evEl.getAttribute('data-event-id') || evEl.querySelector('[data-event-id]')?.getAttribute('data-event-id') || '';
      ctxMenu.dataset.eventId = eid;
      // show delete option only for real events (not synthetic birthdays which start with 'birth-')
      if (eid && !String(eid).startsWith('birth-')) {
        ctxMenu.querySelector('[data-action="delete_event"]').style.display = 'block';
      } else {
        ctxMenu.querySelector('[data-action="delete_event"]').style.display = 'none';
      }
      // hide date dataset
      ctxMenu.dataset.date = '';
    } else {
      ctxMenu.dataset.eventId = '';
      ctxMenu.querySelector('[data-action="delete_event"]').style.display = 'none';
      const cell = ev.target.closest('.fc-daygrid-day');
      ctxMenu.dataset.date = cell ? cell.getAttribute('data-date') : '';
    }
    ctxMenu.style.display = 'block';
  });

  // also attach contextmenu handlers to event elements when they mount
  // This is handled by eventDidMount below which can add attribute data-event-id

  // hide context menu on click elsewhere
  document.addEventListener('click', function() { ctxMenu.style.display = 'none'; });

  // handle menu actions
  ctxMenu.addEventListener('click', function(ev) {
    ev.preventDefault();
    const btn = ev.target.closest('[data-action]');
    if (!btn) return;
    const action = btn.dataset.action;
    const selectedDate = ctxMenu.dataset.date || new Date().toISOString().slice(0,10);
    const targetEventId = ctxMenu.dataset.eventId;
    if (action === 'add_event') {
      document.getElementById('evt_title').value = '';
      document.getElementById('evt_when').value = selectedDate + 'T09:00';
      document.getElementById('evt_type').value = 'task';
      document.getElementById('evt_notes').value = '';
      new bootstrap.Modal(document.getElementById('createEventModal')).show();
      // clear edit mode
      window.__editingEventId = null;
    } else if (action === 'add_birthday') {
      // open modal prefilled for a birthday call (type 'birthday')
      document.getElementById('evt_title').value = 'Birthday Call';
      document.getElementById('evt_when').value = selectedDate + 'T10:00';
      document.getElementById('evt_type').value = 'birthday';
      document.getElementById('evt_notes').value = 'Birthday wishes / check-in';
      new bootstrap.Modal(document.getElementById('createEventModal')).show();
    } else if (action === 'quick_followup') {
      // open modal prefilled for a quick follow-up (+1 day) so user can edit before saving
      const dt = new Date(); dt.setDate(dt.getDate()+1); dt.setHours(10,0,0,0);
      // format to local datetime-local input value (YYYY-MM-DDTHH:MM)
      const pad = (n)=> String(n).padStart(2,'0');
      const localStr = dt.getFullYear() + '-' + pad(dt.getMonth()+1) + '-' + pad(dt.getDate()) + 'T' + pad(dt.getHours()) + ':' + pad(dt.getMinutes());
      document.getElementById('evt_title').value = 'Quick Follow-up';
      document.getElementById('evt_when').value = localStr;
      document.getElementById('evt_type').value = 'call_followup';
      document.getElementById('evt_notes').value = 'Please fill details for this follow-up.';
      new bootstrap.Modal(document.getElementById('createEventModal')).show();
      window.__editingEventId = null;
    } else if (action === 'delete_event') {
      if (!targetEventId) { alert('No event selected'); return; }
      if (!confirm('Delete this event? This cannot be undone.')) return;
      fetch("{% url 'clients:delete_calendar_event' %}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({ id: targetEventId })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          const ev = calendar.getEventById(String(targetEventId));
          if (ev) ev.remove();
        } else {
          alert('Delete failed: ' + (data.error || 'unknown'));
        }
      })
      .catch(err => alert('Error deleting event: ' + err));
    }
    else if (action === 'edit_event') {
      if (!targetEventId) { alert('No event selected'); return; }
      // open modal prefilled with event data
      const eventObj = calendar.getEventById(String(targetEventId));
      if (!eventObj) { alert('Event not found in calendar'); return; }
      // populate modal fields
      document.getElementById('evt_title').value = eventObj.title || '';
      // convert ISO to local datetime-local value
      const dt = new Date(eventObj.start);
      const pad = (n)=> String(n).padStart(2,'0');
      const localStr = dt.getFullYear() + '-' + pad(dt.getMonth()+1) + '-' + pad(dt.getDate()) + 'T' + pad(dt.getHours()) + ':' + pad(dt.getMinutes());
      document.getElementById('evt_when').value = localStr;
      // end time
      const endInput = document.getElementById('evt_end');
      if (endInput) {
        const endDt = eventObj.end ? new Date(eventObj.end) : null;
        if (endDt) {
          const endLocal = endDt.getFullYear() + '-' + pad(endDt.getMonth()+1) + '-' + pad(endDt.getDate()) + 'T' + pad(endDt.getHours()) + ':' + pad(endDt.getMinutes());
          endInput.value = endLocal;
        } else {
          endInput.value = '';
        }
      }
      document.getElementById('evt_type').value = (eventObj.extendedProps && eventObj.extendedProps.type) || 'task';
      document.getElementById('evt_notes').value = (eventObj.extendedProps && eventObj.extendedProps.notes) || '';
      // set editing id so submit uses update endpoint
      window.__editingEventId = String(targetEventId);
      new bootstrap.Modal(document.getElementById('createEventModal')).show();
    }
    ctxMenu.style.display = 'none';
  });

  // filter toggles â†’ refetch events when a checkbox changes
  const refetch = () => calendar.refetchEvents();
  document.querySelectorAll('.evt-filter').forEach(cb => cb.addEventListener('change', refetch));
  document.querySelectorAll('.src-filter').forEach(cb => cb.addEventListener('change', refetch));
  document.querySelectorAll('.status-filter').forEach(cb => cb.addEventListener('change', refetch));

  // Mobile floating add button (visible on small screens)
  const addBtn = document.createElement('button');
  addBtn.className = 'btn btn-primary shadow-lg d-md-none';
  addBtn.style.position = 'fixed';
  addBtn.style.right = '16px';
  addBtn.style.bottom = '16px';
  addBtn.style.borderRadius = '50%';
  addBtn.style.width = '60px';
  addBtn.style.height = '60px';
  addBtn.style.fontSize = '30px';
  addBtn.innerHTML = '+';
  addBtn.title = 'Add Event';
  addBtn.addEventListener('click', function(){
    document.getElementById('evt_title').value = '';
    // set current local datetime (approx)
    const now = new Date();
    const isoLocal = now.toISOString().slice(0,16);
    document.getElementById('evt_when').value = isoLocal;
    new bootstrap.Modal(document.getElementById('createEventModal')).show();
  });
  document.body.appendChild(addBtn);

  // Create event submit
  document.getElementById('createEventSubmit').addEventListener('click', function() {
    const endInput = document.getElementById('evt_end');
    const payload = {
      title: document.getElementById('evt_title').value,
      scheduled_time: document.getElementById('evt_when').value ? new Date(document.getElementById('evt_when').value).toISOString() : new Date().toISOString(),
      end_time: endInput && endInput.value ? new Date(endInput.value).toISOString() : null,
      type: document.getElementById('evt_type').value,
      notes: document.getElementById('evt_notes').value
    };
    // if we're editing an existing event, call update endpoint
    if (window.__editingEventId) {
      payload.id = window.__editingEventId;
      fetch("{% url 'clients:update_calendar_event_details' %}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(data => {
        if (data.success && data.event) {
          const ev = calendar.getEventById(String(data.event.id));
          if (ev) {
            ev.setProp('title', data.event.title);
            ev.setStart(data.event.start);
            // update extendedProps
            if (data.event.extendedProps) {
              ev.setExtendedProp('type', data.event.extendedProps.type);
              ev.setExtendedProp('notes', data.event.extendedProps.notes);
            }
          } else {
            // if not in calendar yet, add
            calendar.addEvent({ id: data.event.id, title: data.event.title, start: data.event.start, extendedProps: data.event.extendedProps });
          }
          new bootstrap.Modal(document.getElementById('createEventModal')).hide();
          window.__editingEventId = null;
          showToast('Saved', 'Event updated successfully', 'success');
        } else {
          showToast('Error', 'Failed to update event: ' + (data.error || 'unknown'), 'danger');
        }
      })
      .catch(err => alert('Error updating event: ' + err));
    } else {
      createEvent(payload, true);
    }
  });

  // wire Edit button in detail modal to open create modal in edit mode
  document.getElementById('eventDetailEdit').addEventListener('click', function(){
    // read current modal title and props then open create modal
    const title = document.getElementById('modalTitle').innerText || '';
    const whenText = document.getElementById('modalWhen').innerText || '';
    const notes = document.getElementById('modalNotes').innerText || '';
    const typeText = document.getElementById('modalType').innerText || '';
    // populate create modal fields; keep editing id from last right-click context (if any)
    document.getElementById('evt_title').value = title;
    // attempt to parse whenText back to datetime-local; fallback to now
    document.getElementById('evt_notes').value = notes === 'â€”' ? '' : notes;
    document.getElementById('evt_type').value = typeText && typeText !== 'â€”' ? typeText : 'task';
    // show create modal; editing id should already be set when Edit was requested from context menu
    new bootstrap.Modal(document.getElementById('createEventModal')).show();
    // update button text
    updateCreateButtonLabel();
    // hide detail modal
    var detailModal = bootstrap.Modal.getInstance(document.getElementById('eventDetailModal'));
    if (detailModal) detailModal.hide();
  });

  // Create follow-up for synthetic birthday events (read-only) -> adds real follow-up
  document.getElementById('modalBirthdayFollowup').addEventListener('click', function(){
    const modalTitle = document.getElementById('modalTitle').innerText || 'Birthday';
    const modalWhen = document.getElementById('modalWhen').innerText;
    const targetStart = modalWhen ? new Date(modalWhen).toISOString() : new Date().toISOString();
    const title = `Birthday Follow-up: ${modalTitle.replace('Birthday:', '').trim()}`;
    createEvent({
      title: title,
      scheduled_time: targetStart,
      type: 'call_followup',
      notes: 'Auto-created from birthday reminder'
    }, true);
    const detailModal = bootstrap.Modal.getInstance(document.getElementById('eventDetailModal'));
    if (detailModal) detailModal.hide();
  });

  // Helper to POST create event and add to calendar
  function createEvent(payload, closeModal) {
    fetch("{% url 'clients:create_calendar_event' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
      if (data.success && data.event) {
        calendar.addEvent({
          id: data.event.id,
          title: data.event.title,
          start: data.event.start,
          end: data.event.end || null,
          extendedProps: data.event.extendedProps
        });
        if (closeModal) new bootstrap.Modal(document.getElementById('createEventModal')).hide();
        showToast('Created', 'Event created successfully', 'success');
      } else {
        showToast('Error', 'Failed to create event: ' + (data.error || 'unknown'), 'danger');
      }
    })
    .catch(err => { alert('Error: ' + err); });
  }

  // small toast utility using Bootstrap toasts
  function showToast(title, message, variant) {
    variant = variant || 'primary';
    const toastId = 'toast-' + Date.now();
    const container = document.getElementById('toastContainer');
    const tpl = document.createElement('div');
    tpl.innerHTML = `
      <div id="${toastId}" class="toast align-items-center text-bg-${variant} border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body"><strong>${title}:</strong> ${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>`;
    container.appendChild(tpl.firstElementChild);
    const bsToast = new bootstrap.Toast(document.getElementById(toastId), { delay: 4000 });
    bsToast.show();
    // cleanup after hidden
    document.getElementById(toastId).addEventListener('hidden.bs.toast', function(){ this.remove(); });
  }

  // update create button label depending on edit mode
  function updateCreateButtonLabel(){
    const btn = document.getElementById('createEventSubmit');
    if (window.__editingEventId) {
      btn.innerText = 'Save';
    } else {
      btn.innerText = 'Create';
    }
  }

  // ensure label updates when modal opens
  const createModalEl = document.getElementById('createEventModal');
  createModalEl.addEventListener('show.bs.modal', function(){ updateCreateButtonLabel(); });

  // Move modals to document.body on show to avoid stacking-context issues (Brave/macOS)
  ['createEventModal', 'eventDetailModal'].forEach(function(id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('show.bs.modal', function() {
      // append to body so z-index and positioning are not affected by parent stacking contexts
      if (el.parentNode !== document.body) document.body.appendChild(el);
    });
  });

  // ðŸ”¹ Ajax update when event moved/resized
  function updateEventTime(event) {
    fetch("{% url 'clients:update_calendar_event' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        id: event.id,
        start: event.start.toISOString(),
        end: event.end ? event.end.toISOString() : null
      })
    })
    .then(response => {
      if (!response.ok) throw new Error("Failed to update event.");
      return response.json();
    })
    .then(data => {
      if (!data.success) alert("Update failed!");
    })
    .catch(err => {
      alert(err);
      event.setDates(event.oldStart, event.oldEnd); // rollback if failed
    });
  }
});
</script>
{% endblock %}
